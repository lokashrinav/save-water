{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="text-center mb-4">
            <i class="fas fa-upload"></i> Upload Pipeline Data for Analysis
        </h2>
        
        <form action="{{ url_for('upload_file') }}" method="post" enctype="multipart/form-data" id="uploadForm">
            <!-- File Upload Section -->
            <div class="mb-4">
                <label for="geojson_file" class="form-label">
                    <i class="fas fa-map"></i> Pipeline GeoJSON File
                </label>
                <div class="file-upload-area" id="fileUploadArea">
                    <input type="file" name="geojson_file" id="geojson_file" class="d-none" accept=".geojson,.json" required>
                    <div id="uploadContent">
                        <i class="fas fa-cloud-upload-alt feature-icon"></i>
                        <h5>Click to select or drag & drop your GeoJSON file</h5>
                        <p class="text-muted mb-0">Supported formats: .geojson, .json (Max: 16MB)</p>
                    </div>
                    <div id="fileSelected" class="d-none">
                        <i class="fas fa-file-check feature-icon text-success"></i>
                        <h5 id="fileName" class="text-success"></h5>
                        <p class="text-muted mb-0">File ready for upload</p>
                    </div>
                </div>
            </div>
            
            <!-- Date Selection -->
            <div class="row mb-4">
                <div class="col-md-8">
                    <label for="target_date" class="form-label">
                        <i class="fas fa-calendar"></i> Target Date for Analysis
                    </label>
                    <input type="date" name="target_date" id="target_date" class="form-control" required>
                    <div class="form-text">Select the date when you suspect a leak occurred</div>
                </div>
                <div class="col-md-4">
                    <label for="days_tolerance" class="form-label">
                        <i class="fas fa-clock"></i> Days Tolerance
                    </label>
                    <select name="days_tolerance" id="days_tolerance" class="form-select">
                        <option value="3">3 days</option>
                        <option value="5" selected>5 days</option>
                        <option value="7">7 days</option>
                        <option value="10">10 days</option>
                    </select>
                    <div class="form-text">Acceptable date range for satellite imagery</div>
                </div>
            </div>
            
            <!-- Analysis Information -->
            <div class="alert alert-info">
                <h5><i class="fas fa-info-circle"></i> What happens next?</h5>
                <ul class="mb-0">
                    <li>Download Sentinel-2 satellite imagery for your pipeline area</li>
                    <li>Calculate Normalized Difference Water Index (NDWI)</li>
                    <li>Apply geospatial masking to focus on pipeline areas</li>
                    <li>Detect changes that may indicate leaks</li>
                    <li>Generate comprehensive PDF report with visualizations</li>
                </ul>
            </div>
            
            <!-- Submit Button -->
            <div class="text-center">
                <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                    <i class="fas fa-search"></i> Start Leak Detection Analysis
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Features Section -->
<div class="row mt-5">
    <div class="col-md-4 text-center mb-4">
        <div class="feature-icon">
            <i class="fas fa-satellite"></i>
        </div>
        <h5>Satellite Analysis</h5>
        <p class="text-muted">Uses Sentinel-2 satellite imagery for comprehensive coverage</p>
    </div>
    <div class="col-md-4 text-center mb-4">
        <div class="feature-icon">
            <i class="fas fa-eye"></i>
        </div>
        <h5>Change Detection</h5>
        <p class="text-muted">Advanced algorithms detect water-related changes over time</p>
    </div>
    <div class="col-md-4 text-center mb-4">
        <div class="feature-icon">
            <i class="fas fa-file-pdf"></i>
        </div>
        <h5>Detailed Reports</h5>
        <p class="text-muted">Professional PDF reports with maps and analysis results</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const fileUploadArea = document.getElementById('fileUploadArea');
    const fileInput = document.getElementById('geojson_file');
    const uploadContent = document.getElementById('uploadContent');
    const fileSelected = document.getElementById('fileSelected');
    const fileName = document.getElementById('fileName');
    const submitBtn = document.getElementById('submitBtn');
    const form = document.getElementById('uploadForm');
    
    // Set default date to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('target_date').value = today;
    
    // File upload area click handler
    fileUploadArea.addEventListener('click', function() {
        fileInput.click();
    });
    
    // File input change handler
    fileInput.addEventListener('change', function() {
        if (this.files.length > 0) {
            const file = this.files[0];
            fileName.textContent = file.name;
            uploadContent.classList.add('d-none');
            fileSelected.classList.remove('d-none');
            fileUploadArea.style.borderColor = '#1cc88a';
            fileUploadArea.style.backgroundColor = '#f0f8f5';
        }
    });
    
    // Drag and drop handlers
    fileUploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.classList.add('dragover');
    });
    
    fileUploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        this.classList.remove('dragover');
    });
    
    fileUploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        this.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            const file = files[0];
            if (file.name.toLowerCase().endsWith('.geojson') || file.name.toLowerCase().endsWith('.json')) {
                fileInput.files = files;
                fileName.textContent = file.name;
                uploadContent.classList.add('d-none');
                fileSelected.classList.remove('d-none');
                this.style.borderColor = '#1cc88a';
                this.style.backgroundColor = '#f0f8f5';
            } else {
                alert('Please select a GeoJSON or JSON file.');
            }
        }
    });
    
    // Form submission handler
    form.addEventListener('submit', function(e) {
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        submitBtn.disabled = true;
        
        // Show processing message
        const processingAlert = document.createElement('div');
        processingAlert.className = 'alert alert-warning mt-3';
        processingAlert.innerHTML = `
            <i class="fas fa-cog fa-spin"></i> 
            <strong>Analysis in progress...</strong> This may take several minutes depending on the area size and date range.
        `;
        form.appendChild(processingAlert);
    });
});
</script>
{% endblock %}
